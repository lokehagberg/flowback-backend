# Generated by Django 4.2.17 on 2025-11-26 13:03

from django.db import migrations, models
import django.db.models.deletion
from django.db.models import Max


def populate_poll_result(apps, schema_editor):
    Poll = apps.get_model('poll', 'Poll')
    PollProposal = apps.get_model('poll', 'PollProposal')
    for poll in Poll.objects.all():
        winning_proposal = PollProposal.objects.filter(poll_id=poll.id).order_by('-score', '-pollproposaltypeschedule__event_start_date').first()
        if winning_proposal and poll.status == 1:
            poll.result = winning_proposal
            poll.save()


class Migration(migrations.Migration):

    dependencies = [
        ('poll', '0049_poll_schedule_poll_meeting_link'),
    ]

    operations = [
        migrations.RemoveField(
            model_name='poll',
            name='result',
        ),
        migrations.AddField(
            model_name='poll',
            name='result',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='winning_proposal', to='poll.pollproposal'),
        ),
        migrations.RunPython(populate_poll_result)
    ]
